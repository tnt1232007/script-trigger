<header>
  <nav class="navbar navbar-expand navbar-dark bg-primary fixed-top" [ngClass]="{'fixed-padding': commands.length > 0}">
    <a class="navbar-brand" href="#top" draggable="false">
      <img src="assets/script.png" width="30" height="30" class="d-inline-block align-top" alt="">
    </a>
    <ul class="navbar-nav mr-auto">
      <li class="nav-item">
        <a class="nav-link" pageScroll [pageScrollEasing]="easeInOutExpoEasing" href="#top">Home</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" pageScroll [pageScrollEasing]="easeInOutExpoEasing" href="#commands">Commands</a>
      </li>
      <!-- <li class="nav-item">
        <a class="nav-link" pageScroll [pageScrollEasing]="easeInOutExpoEasing" href="#examples">Examples</a>
      </li> -->
    </ul>
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link text-hover-light" pageScroll [pageScrollEasing]="easeInOutExpoEasing" href="#commands" (click)="onNew(); commandForm.form.reset(); commandModal.show();">
          <app-bytesize-icon id="i-plus" size="22" stroke="2"></app-bytesize-icon>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-hover-light" (click)="import(selectItem('openFile', jsonFilter))">
          <app-bytesize-icon id="i-import" size="22" stroke="2"></app-bytesize-icon>
        </a>
      </li>
      <li class="nav-item d-flex flex-row text-hover-light">
        <a class="nav-link" pageScroll [pageScrollEasing]="easeInOutExpoEasing" href="#commands" (click)="showFilter = true; searchInput.focus();">
          <app-bytesize-icon id="i-search" size="22" stroke="2"></app-bytesize-icon>
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-hover-light" (click)="configModal.show();">
          <app-bytesize-icon id="i-settings" size="22" stroke="2"></app-bytesize-icon>
        </a>
      </li>
    </ul>
  </nav>
  <input #searchInput [style.opacity]="showFilter || keyword ? '1' : '0'" [(ngModel)]="keyword" (ngModelChange)="filter()"
    id="searchInput" type="search" autofocus="true" (blur)="showFilter = false">
</header>

<main>
  <div *ngIf="!keyword" id="top" class="full-page d-flex align-items-center justify-content-center">
    <div class="content-logo">
      <img alt="" src="assets/script.png">
    </div>
    <div class="content-header d-flex flex-column justify-content-center">
      <h1 class="font-weight-light mb-3">
        ScriptTrigger<small>v{{getAppVersion()}}</small>
      </h1>
      <a class="btn btn-outline-primary py-3 mb-3 text-relax" pageScroll [pageScrollEasing]="easeInOutExpoEasing" href="#commands">GET STARTED</a>
    </div>
  </div>
  <div id="commands" class="fixed-padding-top">
    <bs-sortable [(ngModel)]="commands" [itemTemplate]="itemTemplate" (drop)="afterSort()" wrapperClass="list-group list-group-flush"
      itemClass="sortable-item list-group-item list-group-item-action flex-column align-items-start"></bs-sortable>

    <button *ngIf="commands.length > 0" type="button" class="btn btn-block btn-outline-danger border-0 rounded-0 py-4" mwlConfirmationPopover
      popoverTitle="Are you sure?" popoverMessage="Reset all Runs and Last run statistics" placement="top" (confirm)="resetAllStats()">Reset Runs</button>
  </div>
</main>

<footer>
  <ng-template #itemTemplate let-item="item">
    <div class="d-flex w-100">
      <h5 class="text-primary clickable" (click)="onEdit(item.value); commandModal.show();">
        {{item.value.id}}.{{item.value.name}}
      </h5>
      <small class="ml-auto" *ngIf="item.value.lastRunAt">{{item.value.lastRunAt | amTimeAgo}}</small>
    </div>
    <div class="d-flex w-100 align-items-center">
      <pre class="my-1 mr-3"><code highlight [code]="item.value.script"></code></pre>
      <button type="button" tooltip="Edit" class="btn btn-light rounded-0 showOnHover text-muted text-hover-warning" (click)="onEdit(item.value); commandModal.show();">
        <app-bytesize-icon id="i-edit"></app-bytesize-icon>
      </button>
      <!-- <button type="button" class="btn btn-light rounded-0 showOnHover text-muted" (click)="onDuplicate(item.value); commandModal.show();" tooltip="Duplicate">
        <app-bytesize-icon id="i-clipboard"></app-bytesize-icon>
      </button> -->
      <button type="button" tooltip="Delete" class="btn btn-light rounded-0 showOnHover text-muted text-hover-danger mr-3" mwlConfirmationPopover
        popoverTitle="Are you sure?" popoverMessage="Delete '{{item.value.name}}' permanently" (confirm)="delete(item.value)">
        <app-bytesize-icon id="i-trash"></app-bytesize-icon>
      </button>
      <div class="btn-group ml-auto">
        <button type="button" class="btn btn-danger" (click)="trigger(item.value)">Trigger
          <span class="badge badge-light">{{item.value.runs}}</span>
        </button>
      </div>
    </div>
    <small class="text-muted regex">{{item.value.voice}}&nbsp;</small>
  </ng-template>

  <div bsModal #commandModal="bs-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <form #commandForm="ngForm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{{command.id ? 'Edit' : 'New'}}</h5>
            <button type="button" class="close" (click)="commandModal.hide();">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group row">
              <label for="inputName" class="col-sm-2 col-form-label">Name</label>
              <div class="col-sm-10">
                <input [(ngModel)]="command.name" [ngClass]="{'is-valid': name.valid && !name.pristine, 'is-invalid': !name.valid && !name.pristine}"
                  type="text" class="form-control" id="inputname" name="inputName" #name="ngModel" required>
                <div [hidden]="name.valid || name.pristine" class="invalid-feedback">
                  Name is required
                </div>
              </div>
            </div>
            <div class="form-group row">
              <label for="inputCommand" class="col-sm-2 col-form-label">Script</label>
              <div class="col-sm-10">
                <textarea fz-elastic [(ngModel)]="command.script" [ngClass]="{'is-valid': script.valid && !script.pristine, 'is-invalid': !script.valid && !script.pristine}"
                  class="form-control" id="inputScript" name="inputScript" #script="ngModel" rows="1" required></textarea>
                <div [hidden]="script.valid || script.pristine" class="invalid-feedback">
                  Script is required
                </div>
                <small class="form-text">
                  <a class="text-muted" placement="bottom" tabindex="-1" href="http://roualin.fr/wp-content/uploads/2017/11/powershell-cheat-sheet.jpg"
                    tooltip="http://roualin.fr/wp-content/uploads/2017/11/powershell-cheat-sheet.jpg" containerClass="nowrap">
                    Powershell syntax
                    <app-bytesize-icon id="i-external" size="12" width="2"></app-bytesize-icon>
                  </a>
                </small>
              </div>
            </div>
            <div class="form-group row">
              <label for="inputVoice" class="col-sm-2 col-form-label">Voice</label>
              <div class="col-sm-10">
                <input [(ngModel)]="command.voice" [ngClass]="{'is-valid': voice.valid && !voice.pristine, 'is-invalid': !voice.valid && !voice.pristine}"
                  type="text" class="form-control" name="inputVoice" id="inputVoice" #voice="ngModel">
                <small class="form-text">
                  <a class="text-muted" placement="bottom" tabindex="-1" href="http://files.zeroturnaround.com/pdf/zt_regular-expressions-cheat-sheet.pdf"
                    tooltip="http://files.zeroturnaround.com/pdf/zt_regular-expressions-cheat-sheet.pdf" containerClass="nowrap">
                    Regular Expressions syntax
                    <app-bytesize-icon id="i-external" size="12" width="2"></app-bytesize-icon>
                  </a>
                </small>
              </div>
            </div>
            <ng-container *ngIf="command.voice && isContainParams(command.voice)">
              <div class="form-group row">
                <label for="inputParams" class="col-sm-2 col-form-label">Parameters</label>
                <div class="col-sm-10">
                  <input [(ngModel)]="command.params" [ngClass]="{'is-valid': params.valid && !params.pristine, 'is-invalid': !params.valid && !params.pristine}"
                    type="text" class="form-control" name="inputParams" id="inputParams" #params="ngModel">
                  <small class="form-text text-muted">Comma-separated value params for each (.*) in voice command</small>
                </div>
              </div>
            </ng-container>
            <ng-container *ngIf="command.id">
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">Runs</label>
                <div class="col-sm-10">
                  <label class="form-control-plaintext">{{command.runs}}</label>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">Last run</label>
                <div class="col-sm-10">
                  <label class="form-control-plaintext">{{command.lastRunAt ? (command.lastRunAt | amCalendar) : 'Not run yet'}}</label>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">Updated</label>
                <div class="col-sm-10">
                  <label class="form-control-plaintext">{{command.updatedAt | amCalendar}}</label>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-sm-2 col-form-label">Created</label>
                <div class="col-sm-10">
                  <label class="form-control-plaintext">{{command.createdAt | amCalendar}}</label>
                </div>
              </div>
            </ng-container>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-danger" mwlConfirmationPopover popoverTitle="Are you sure?" popoverMessage="Delete '{{command.name}}' permanently"
              placement="top" (confirm)="delete(); commandModal.hide();" *ngIf="command.id">Delete</button>
            <button type="button" class="btn btn-secondary ml-auto" (click)="commandModal.hide()">Close</button>
            <button type="button" class="btn btn-primary" (click)="commandForm.form.valid && submit(); commandModal.hide();">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div bsModal #configModal="bs-modal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <form #configForm="ngForm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Configuration</h5>
            <button type="button" class="close" (click)="configModal.hide();">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- <div class="form-group row">
              <label for="inputWatchLocation" class="col-sm-3 col-form-label">Watch Location</label>
              <div class="col-sm-9">
                <div class="input-group">
                  <input [(ngModel)]="configuration.watchLocation" type="text" class="form-control" id="inputWatchLocation" name="inputWatchLocation">
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" (click)="configuration.watchLocation = selectItem('openDirectory')">Browse</button>
                  </div>
                </div>
                <small class="form-text text-muted">Activate command by voice, file name default to computer name:
                  <a class="text-muted" placement="bottom" tabindex="-1" href="#" (click)="openItem(storeService.getWatchFilePath())" [tooltip]="storeService.getWatchFilePath()"
                    containerClass="nowrap">
                    {{storeService.getWatchFileName()}}
                    <app-bytesize-icon id="i-external" size="12" width="2"></app-bytesize-icon>
                  </a>
                </small>
              </div>
            </div> -->
            <div class="form-group row">
              <label for="inputPushbulletApiKey" class="col-sm-3 col-form-label">Pushbullet Api Key</label>
              <div class="col-sm-9">
                <div class="input-group">
                  <input [(ngModel)]="configuration.pushbulletApiKey" type="text" class="form-control" id="inputPushbulletApiKey" name="inputPushbulletApiKey">
                </div>
                <small class="form-text">
                  <a class="text-muted" placement="bottom" tabindex="-1" href="https://www.pushbullet.com/#settings/account"
                    tooltip="https://www.pushbullet.com/#settings/account" containerClass="nowrap">
                    Pushbullet > Settings > Create Access Token
                    <app-bytesize-icon id="i-external" size="12" width="2"></app-bytesize-icon>
                  </a>
                </small>
              </div>
            </div>
            <div class="form-group row">
              <label for="inputDatabaseLocation" class="col-sm-3 col-form-label">Database Location</label>
              <div class="col-sm-9">
                <div class="input-group">
                  <input [(ngModel)]="configuration.databaseLocation" type="text" class="form-control" id="inputDatabaseLocation" name="inputDatabaseLocation">
                  <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" (click)="configuration.databaseLocation = selectItem('openDirectory')">Browse</button>
                  </div>
                </div>
                <small class="form-text text-muted">
                  Default to
                  <a class="text-muted" placement="bottom" tabindex="-1" href="#" (click)="openItem(storeService.getConfigLocation())" [tooltip]="storeService.getConfigLocation()"
                    containerClass="nowrap">
                    User AppData folder
                    <app-bytesize-icon id="i-external" size="12" width="2"></app-bytesize-icon>
                  </a>
                </small>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary ml-auto" (click)="configModal.hide()">Close</button>
            <button type="button" class="btn btn-primary" (click)="configForm.form.valid && configFormSubmit(); configModal.hide();">Save</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</footer>